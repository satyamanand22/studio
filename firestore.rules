rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset establishes a "Public Read, Owner Write" security model.
     * The primary purpose of a lost and found application is to allow the public to browse
     * all reports to find matches. Therefore, all reports are publicly readable. However,
     * only the authenticated user who created a report can modify or delete it, ensuring
     * data integrity and preventing unauthorized tampering.
     *
     * Data Structure: The data is organized into two distinct top-level collections:
     * - /lost_item_reports: Contains all reports for items that have been lost.
     * - /found_item_reports: Contains all reports for items that have been found.
     * This separation simplifies querying and security rule logic.
     *
     * Key Security Decisions:
     * - Public Read Access: Both collections are world-readable to allow anyone (including
     *   anonymous users) to browse reports, which is essential for the app's function.
     * - Authenticated Writes: All write operations (create, update, delete) require the
     *   user to be signed in.
     * - Strict Ownership: A user can only create, update, or delete a report they own.
     *   Ownership is determined by the `reporterId` or `finderId` field within the document.
     * - Immutable Ownership: The `reporterId` and `finderId` fields cannot be changed
     *   after a report has been created, preventing ownership transfer.
     */

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function incomingDataHasCorrectOwner(key) {
      return isSignedIn() && request.resource.data[key] == request.auth.uid;
    }

    function ownerIsUnchanged(key) {
      return request.resource.data[key] == resource.data[key];
    }

    // -------------------------------------------------------------------------
    // Collection Rules: /lost_item_reports
    // -------------------------------------------------------------------------

    match /lost_item_reports/{reportId} {
      allow get: if true;
      allow list: if true;
      allow create: if incomingDataHasCorrectOwner('reporterId');
      allow update: if isExistingOwner(resource.data.reporterId) && ownerIsUnchanged('reporterId');
      allow delete: if isExistingOwner(resource.data.reporterId);
    }

    // -------------------------------------------------------------------------
    // Collection Rules: /found_item_reports
    // -------------------------------------------------------------------------

    match /found_item_reports/{reportId} {
      allow get: if true;
      allow list: if true;
      allow create: if incomingDataHasCorrectOwner('finderId');
      allow update: if isExistingOwner(resource.data.finderId) && ownerIsUnchanged('finderId');
      allow delete: if isExistingOwner(resource.data.finderId);
    }
  }
}
